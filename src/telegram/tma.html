<!doctype html>
<html lang="zh-cn" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mail2telegram</title>
    <!-- Telegram WebApp SDK -->
    <script src="https://cors.isteed.cc/https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Tailwind CSS (使用标准 CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // 仅配置暗黑模式策略，不添加自定义颜色
      tailwind.config = {
        darkMode: "class",
      };
    </script>
    <style>
      /* 完全隐藏滚动条 */
      body::-webkit-scrollbar {
        display: none;
      }

      /* Vue 列表动画 */
      .panel-menu-enter-active,
      .panel-menu-leave-active {
        transition: all 0.15s ease-out;
      }
      .panel-menu-enter-from,
      .panel-menu-leave-to {
        opacity: 0;
        transform: translateY(-8px) scale(0.95);
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 dark:bg-black dark:text-gray-200 font-sans antialiased p-2 sm:p-3 min-h-screen">
    <div id="app" class="max-w-[840px] mx-auto flex flex-col gap-4">
      <!-- ==================== 邮件列表面板 ==================== -->
      <section v-if="func === 'mails'" class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-none shadow-sm overflow-hidden">
        <!-- 头部 -->
        <header class="flex justify-between items-center px-2 sm:px-4 py-2 md:py-3 border-b border-gray-100 dark:border-gray-800 relative">
          <button
            class="group flex items-center gap-1 text-lg font-semibold text-gray-800 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-800 pl-3 pr-2 py-1.5 rounded-none transition-all focus:ring-2 focus:ring-sky-500/50 outline-none"
            :class="{ 'bg-gray-50 dark:bg-gray-800': menuOpen }"
            @click="toggleMenu"
          >
            邮件列表
            <svg class="w-4 text-gray-400 group-hover:text-gray-600 dark:text-gray-500 dark:group-hover:text-gray-300 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div class="flex items-center gap-2">
            <button
              class="px-3 py-1.5 rounded-none border border-red-200 dark:border-red-900/50 text-red-600 dark:text-red-400 text-sm font-medium hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors disabled:opacity-50"
              @click="clearSummaryCache"
              :disabled="clearingSummaryCache"
            >
              清除缓存
            </button>
            <button
              class="px-3 py-1.5 rounded-none border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors disabled:opacity-50"
              @click="refreshMails"
              :disabled="loading"
            >
              刷新
            </button>
          </div>

          <!-- 菜单下拉 -->
          <transition name="panel-menu">
            <div v-if="menuOpen" class="absolute top-full left-4 mt-1 rounded-none border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-xl z-50 flex flex-col">
              <button
                v-for="item in menuItems"
                :key="item.value"
                class="w-full text-left px-5 py-2 text-base transition-colors"
                :class="func === item.value ? 'bg-sky-50 dark:bg-sky-900/30 text-sky-600 dark:text-sky-400 font-medium' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                @click="switchPage(item.value)"
              >
                {{ item.label }}
              </button>
            </div>
          </transition>
        </header>

        <!-- 内容区 -->
        <div class="p-2 sm:p-4">
          <!-- 提示信息 -->
          <div
            v-if="tipMessage"
            :class="['mb-4 px-4 py-3 rounded-none text-sm flex items-center gap-2', tipMessage.startsWith('ERROR') ? 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 border border-red-100 dark:border-red-800' : 'bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-400 border border-amber-100 dark:border-amber-800']"
          >
            {{ tipMessage }}
          </div>

          <div v-if="loading && !mailList.length" class="py-12 text-center text-gray-400 dark:text-gray-500 text-sm">加载中...</div>

          <template v-else>
            <div v-if="!mailList.length" class="py-12 text-center text-gray-400 dark:text-gray-500 text-sm">暂无邮件</div>
            <div v-else class="overflow-hidden rounded-none border border-gray-200 dark:border-gray-800">
              <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 dark:bg-gray-800/50">
                  <tr>
                    <th class="py-3 px-4 font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider text-xs">标题</th>
                    <th class="py-3 px-4 font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider text-xs w-[80px] text-right">操作</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                  <tr v-for="mail in mailList" :key="mail.id" class="group hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                    <td class="py-3 px-4 text-gray-700 dark:text-gray-300 font-medium break-words">{{ mail.subject || '(无标题)' }}</td>
                    <td class="py-3 px-4 text-right">
                      <button
                        class="px-2.5 py-1.5 rounded-none border border-sky-600 bg-sky-600 text-white text-xs hover:bg-sky-700 hover:border-sky-700 transition-colors shadow-sm"
                        @click="viewMail(mail.id)"
                      >
                        查看
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button
              v-if="hasMore"
              class="w-full mt-4 py-2.5 rounded-none border border-gray-200 dark:border-gray-700 text-sky-600 dark:text-sky-400 text-sm font-medium hover:bg-sky-50 dark:hover:bg-sky-900/10 transition-colors"
              @click="loadMoreMails"
            >
              加载更多
            </button>
          </template>
        </div>
      </section>

      <!-- ==================== 邮件详情面板 ==================== -->
      <section v-if="func === 'mail-detail' && currentMail" class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-none shadow-sm overflow-hidden">
        <header class="flex justify-between items-center px-2 sm:px-4 py-2 md:py-3 border-b border-gray-100 dark:border-gray-800 relative">
          <button
            class="flex items-center gap-2 text-lg font-semibold text-gray-800 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-800 px-3 py-1.5 rounded-none transition-colors"
            @click="toggleMenu"
          >
            邮件详情
          </button>
          <div class="flex items-center gap-2">
            <button
              class="px-3 py-1.5 rounded-none border border-red-200 dark:border-red-900/50 text-red-600 dark:text-red-400 text-sm font-medium hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors disabled:opacity-50"
              @click="deleteCurrentMail"
              :disabled="deletingMail"
            >
              删除
            </button>
            <button
              class="px-3 py-1.5 rounded-none border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
              @click="backToList"
            >
              返回
            </button>
          </div>
          <transition name="panel-menu">
            <div v-if="menuOpen" class="absolute top-full left-4 mt-1 rounded-none border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-xl z-50 flex flex-col">
              <button
                v-for="item in menuItems"
                :key="item.value"
                class="w-full text-left px-5 py-2 text-base transition-colors"
                :class="func === item.value ? 'bg-sky-50 dark:bg-sky-900/30 text-sky-600 dark:text-sky-400 font-medium' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                @click="switchPage(item.value)"
              >
                {{ item.label }}
              </button>
            </div>
          </transition>
        </header>

        <div class="p-2 sm:p-4">
          <div
            v-if="tipMessage"
            :class="['mb-4 px-4 py-3 rounded-none text-sm', tipMessage.startsWith('ERROR') ? 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300' : 'bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-400']"
          >
            {{ tipMessage }}
          </div>

          <!-- 邮件元数据 -->
          <div class="bg-gray-50 dark:bg-gray-800/40 rounded-none border border-gray-100 dark:border-gray-800 mb-6 p-4 space-y-2">
            <div class="grid grid-cols-[70px_1fr] gap-3 items-baseline border-b border-gray-200 dark:border-gray-700 pb-2 last:border-0 last:pb-0">
              <span class="text-xs font-semibold text-gray-500 uppercase">发件人</span>
              <span class="font-mono text-sm text-gray-700 dark:text-gray-300 break-all select-all">{{ currentMail.from }}</span>
            </div>
            <div class="grid grid-cols-[70px_1fr] gap-3 items-baseline border-b border-gray-200 dark:border-gray-700 pb-2 last:border-0 last:pb-0">
              <span class="text-xs font-semibold text-gray-500 uppercase">收件人</span>
              <span class="font-mono text-sm text-gray-700 dark:text-gray-300 break-all select-all">{{ currentMail.to }}</span>
            </div>
            <div v-if="currentMail.receivedAt" class="grid grid-cols-[70px_1fr] gap-3 items-baseline pb-1">
              <span class="text-xs font-semibold text-gray-500 uppercase">时间</span>
              <span class="font-mono text-sm text-gray-700 dark:text-gray-300">{{ formatFullDateTime(currentMail.receivedAt) }}</span>
            </div>
          </div>

          <h2 class="my-6 text-xl sm:text-2xl font-bold text-gray-900 dark:text-white leading-snug">{{ currentMail.subject || '(无标题)' }}</h2>

          <!-- 视图切换 Tab -->
          <div class="flex flex-wrap gap-2 mb-4">
            <button
              v-if="currentMail.html"
              class="px-4 py-1.5 rounded-none border text-sm font-medium transition-all"
              :class="mailViewMode === 'html' ? 'bg-sky-600 border-sky-600 text-white shadow-md' : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'"
              @click="setMailViewMode('html')"
            >
              HTML
            </button>
            <button
              v-if="currentMail.text"
              class="px-4 py-1.5 rounded-none border text-sm font-medium transition-all"
              :class="mailViewMode === 'text' ? 'bg-sky-600 border-sky-600 text-white shadow-md' : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'"
              @click="setMailViewMode('text')"
            >
              纯文本
            </button>
            <button
              class="px-4 py-1.5 rounded-none border text-sm font-medium transition-all flex items-center gap-1.5"
              :class="mailViewMode === 'summary' ? 'bg-sky-600 border-sky-600 text-white shadow-md' : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'"
              @click="setMailViewMode('summary')"
            >
              AI 摘要
            </button>
          </div>

          <!-- 内容展示区域 -->
          <div v-if="mailViewMode === 'html' && currentMail.html" class="w-full bg-white rounded-none border border-gray-200 dark:border-gray-700 overflow-hidden">
            <iframe
              id="mail-content-frame"
              :srcdoc="'<style>body{margin:0;padding:20px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;color:#333;word-wrap:break-word;}</style>' + currentMail.html"
              class="w-full border-none block"
              title="邮件正文预览"
              @load="syncFrameHeight"
            ></iframe>
          </div>

          <div v-else-if="mailViewMode === 'text' && currentMail.text" class="border border-gray-200 dark:border-gray-700 rounded-none p-4 bg-gray-50 dark:bg-gray-900 max-h-[600px] overflow-auto">
            <div class="font-mono text-sm leading-7 text-gray-700 dark:text-gray-300 whitespace-pre-wrap break-words" v-html="textMailHtml"></div>
          </div>

          <div v-else-if="mailViewMode === 'summary'" class="border border-gray-200 dark:border-gray-700 rounded-none p-5 bg-amber-50/50 dark:bg-amber-900/10 min-h-[120px]">
            <div v-if="summary.loading" class="flex flex-col items-center py-6 text-gray-500 animate-pulse">
              <span>正在分析邮件内容...</span>
            </div>
            <div v-else-if="summary.error" class="text-center py-6 text-red-500 text-sm">{{ summary.error }}</div>
            <template v-else-if="summary.text">
              <pre class="font-sans text-sm sm:text-base leading-7 text-gray-800 dark:text-gray-200 whitespace-pre-wrap break-words">{{ summary.text }}</pre>
              <div v-if="summaryLabel" class="mt-4 pt-3 border-t border-amber-200/50 dark:border-amber-800/50 text-xs text-amber-600 dark:text-amber-500/70 font-medium uppercase tracking-wide">
                来源：{{ summaryLabel }}
              </div>
            </template>
            <div v-else class="text-center py-8 text-gray-400 dark:text-gray-500 text-sm">点击上方“AI 摘要”按钮生成内容</div>
          </div>

          <div v-else class="border border-gray-200 dark:border-gray-700 rounded-none p-8 bg-gray-50 dark:bg-gray-800/50 text-center text-gray-400 text-sm">(正文内容为空)</div>
        </div>
      </section>

      <!-- ==================== 地址管理面板 ==================== -->
      <section v-if="func === 'list'" class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-none shadow-sm overflow-hidden">
        <header class="flex justify-between items-center px-2 sm:px-4 py-2 md:py-3 border-b border-gray-100 dark:border-gray-800 relative">
          <button
            class="group flex items-center gap-1 text-lg font-semibold text-gray-800 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-800 pl-3 pr-2 py-1.5 rounded-none transition-all focus:ring-2 focus:ring-sky-500/50 outline-none"
            :class="{ 'bg-gray-50 dark:bg-gray-800': menuOpen }"
            @click="toggleMenu"
          >
            地址管理
            <svg class="w-4 text-gray-400 group-hover:text-gray-600 dark:text-gray-500 dark:group-hover:text-gray-300 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="flex items-center">
            <select
              v-model="mode"
              class="px-2 py-1.5 rounded-none border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-sm focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-colors cursor-pointer"
            >
              <option value="block">黑名单</option>
              <option value="white">白名单</option>
              <option value="test">测试地址</option>
            </select>
          </div>
          <transition name="panel-menu">
            <div v-if="menuOpen" class="absolute top-full left-4 mt-1 rounded-none border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-xl z-50 flex flex-col">
              <button
                v-for="item in menuItems"
                :key="item.value"
                class="w-full text-left px-5 py-2 text-base transition-colors"
                :class="func === item.value ? 'bg-sky-50 dark:bg-sky-900/30 text-sky-600 dark:text-sky-400 font-medium' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                @click="switchPage(item.value)"
              >
                {{ item.label }}
              </button>
            </div>
          </transition>
        </header>

        <div class="p-2 sm:p-4">
          <div
            v-if="tipMessage"
            :class="['mb-4 px-4 py-3 rounded-none text-sm', tipMessage.startsWith('ERROR') ? 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300' : 'bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-400']"
          >
            {{ tipMessage }}
          </div>

          <template v-if="mode !== 'test'">
            <div class="flex flex-col sm:flex-row gap-3 mb-4">
              <input
                v-model="inputAddress"
                :placeholder="inputPlaceholder"
                @keyup.enter="addAddress"
                class="flex-1 px-3 py-2.5 rounded-none border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 text-sm placeholder-gray-400 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-all shadow-sm"
              />
              <button
                class="px-5 py-2.5 rounded-none border border-sky-600 bg-sky-600 text-white text-sm font-medium hover:bg-sky-700 transition-colors shadow-sm whitespace-nowrap"
                @click="addAddress"
              >
                添加规则
              </button>
            </div>

            <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-none overflow-hidden">
              <ul v-if="addresses.length" class="divide-y divide-gray-100 dark:divide-gray-800">
                <li v-for="(address, index) in addresses" :key="address + index" class="flex justify-between items-center gap-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                  <span class="font-mono text-sm text-gray-700 dark:text-gray-300 break-all">{{ address }}</span>
                  <button
                    class="shrink-0 text-red-500 hover:text-red-700 dark:hover:text-red-400 text-xs font-medium px-2 py-1 rounded-none hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                    @click="removeAddress(index)"
                  >
                    移除
                  </button>
                </li>
              </ul>
              <div v-else class="py-8 text-center text-gray-400 dark:text-gray-600 text-sm">列表为空</div>
            </div>
          </template>

          <template v-else>
            <div class="flex flex-col sm:flex-row gap-3 mb-4">
              <input
                v-model="inputAddress"
                :placeholder="inputPlaceholder"
                class="flex-1 px-3 py-2.5 rounded-none border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 text-sm placeholder-gray-400 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-all shadow-sm"
              />
              <button
                class="px-5 py-2.5 rounded-none border border-sky-600 bg-sky-600 text-white text-sm font-medium hover:bg-sky-700 transition-colors shadow-sm whitespace-nowrap"
                @click="testAddress"
              >
                手动测试
              </button>
            </div>

            <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-none overflow-hidden">
              <ul v-if="addresses.length" class="divide-y divide-gray-100 dark:divide-gray-800">
                <li v-for="(item, index) in addresses" :key="item.address + index" class="flex justify-between items-center gap-3 px-4 py-3">
                  <span class="font-mono text-sm text-gray-700 dark:text-gray-300 break-all">{{ item.address }}</span>
                  <span
                    class="px-2 py-0.5 rounded-none text-xs font-bold uppercase tracking-wide"
                    :class="item.result === 'block' ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' : 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300'"
                  >
                    {{ item.result }}
                  </span>
                </li>
              </ul>
              <div v-else class="py-8 text-center text-gray-400 dark:text-gray-600 text-sm">请输入邮箱地址进行实时测试</div>
            </div>
          </template>
        </div>
      </section>

      <!-- ==================== 发送邮件面板 ==================== -->
      <section v-if="func === 'sendmail'" class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-none shadow-sm overflow-hidden">
        <header class="flex justify-between items-center px-2 sm:px-4 py-2 md:py-3 border-b border-gray-100 dark:border-gray-800 relative">
          <button
            class="group flex items-center gap-1 text-lg font-semibold text-gray-800 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-800 pl-3 pr-2 py-1.5 rounded-none transition-all focus:ring-2 focus:ring-sky-500/50 outline-none"
            :class="{ 'bg-gray-50 dark:bg-gray-800': menuOpen }"
            @click="toggleMenu"
          >
            发送邮件
            <svg class="w-4 text-gray-400 group-hover:text-gray-600 dark:text-gray-500 dark:group-hover:text-gray-300 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <transition name="panel-menu">
            <div v-if="menuOpen" class="absolute top-full left-4 mt-1 rounded-none border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-xl z-50 flex flex-col">
              <button
                v-for="item in menuItems"
                :key="item.value"
                class="w-full text-left px-5 py-2 text-base transition-colors"
                :class="func === item.value ? 'bg-sky-50 dark:bg-sky-900/30 text-sky-600 dark:text-sky-400 font-medium' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                @click="switchPage(item.value)"
              >
                {{ item.label }}
              </button>
            </div>
          </transition>
        </header>

        <div class="p-2 sm:p-4 space-y-4">
          <div
            v-if="tipMessage"
            :class="['px-4 py-3 rounded-none text-sm', tipMessage.startsWith('ERROR') ? 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300' : 'bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-400']"
          >
            {{ tipMessage }}
          </div>

          <div class="space-y-4">
            <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
              <label class="w-20 text-sm text-gray-500 font-medium">发件人</label>
              <input
                type="email"
                v-model="sendMail.from"
                placeholder="sender@example.com"
                class="flex-1 px-3 py-2 rounded-none border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 text-sm focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-all shadow-sm placeholder-gray-400"
              />
            </div>
            <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
              <label class="w-20 text-sm text-gray-500 font-medium">收件人</label>
              <input
                type="email"
                v-model="sendMail.to"
                placeholder="recipient@example.com"
                class="flex-1 px-3 py-2 rounded-none border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 text-sm focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-all shadow-sm placeholder-gray-400"
              />
            </div>
            <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
              <label class="w-20 text-sm text-gray-500 font-medium">标题</label>
              <input
                type="text"
                v-model="sendMail.subject"
                placeholder="邮件标题"
                class="flex-1 px-3 py-2 rounded-none border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 text-sm focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-all shadow-sm placeholder-gray-400"
              />
            </div>
            <div class="flex flex-col sm:flex-row gap-2 items-start">
              <label class="w-20 pt-2 text-sm text-gray-500 font-medium">正文</label>
              <textarea
                v-model="sendMail.text"
                placeholder="邮件正文"
                class="flex-1 min-h-[180px] px-3 py-2 rounded-none border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 text-sm focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition-all shadow-sm placeholder-gray-400 resize-y font-mono leading-relaxed"
              ></textarea>
            </div>
          </div>

          <div class="pt-4">
            <button class="w-full py-2.5 rounded-none bg-sky-600 text-white text-sm font-semibold hover:bg-sky-700 transition-colors shadow-sm focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
              发送邮件
            </button>
          </div>
        </div>
      </section>

      <!-- 返回顶部 -->
      <button
        class="fixed right-4 bottom-20 z-40 px-4 py-2 rounded-none bg-sky-600 text-white text-sm font-medium shadow-lg transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl hover:bg-sky-700"
        :class="showScrollTop ? 'opacity-100 visible translate-y-0' : 'opacity-0 invisible translate-y-4'"
        @click="scrollToTop"
      >
        ↑ 返回顶部
      </button>
    </div>

    <script>
      // 主题管理
      const applyTheme = (scheme) => {
        if (scheme === "dark") {
          document.documentElement.classList.add("dark");
          document.documentElement.classList.remove("light");
        } else {
          document.documentElement.classList.remove("dark");
          document.documentElement.classList.add("light");
        }
      };

      const initTheme = () => {
        // 1. 尝试从 Telegram WebApp 获取
        const tg = window.Telegram?.WebApp;
        if (tg) {
          applyTheme(tg.colorScheme);
          tg.onEvent?.("themeChanged", () => applyTheme(tg.colorScheme));
        } else {
          // 2. 否则跟随系统
          const media = window.matchMedia("(prefers-color-scheme: dark)");
          const sync = () => applyTheme(media.matches ? "dark" : "light");
          sync();
          media.addEventListener("change", sync);
        }
      };
      initTheme();

      const safeError = (error) => (error instanceof Error ? error.message : String(error ?? ""));

      // 安全转义
      const escapeHtml = (text) => {
        if (!text) return "";
        return String(text).replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            })[m],
        );
      };

      // 链接识别
      const linkify = (text) => {
        if (!text) return "";
        const urlRegex = /((?:https?:\/\/|mailto:)[^\s<>"']+)/gi;
        return String(text)
          .split(urlRegex)
          .map((part, i) => {
            if (i % 2 === 0) return escapeHtml(part).replace(/\r?\n/g, "<br />");
            const cleanUrl = escapeHtml(part).replace(/[.,;!?)]$/, "");
            const suffix = escapeHtml(part).slice(cleanUrl.length);
            return `<a href="${cleanUrl}" target="_blank" class="text-sky-600 hover:underline break-all">${cleanUrl}</a>${suffix}`;
          })
          .join("");
      };

      const matchPattern = (pattern, address) => {
        if (!pattern || !address) return false;
        const patternTrimmed = pattern.trim();
        const addressTrimmed = address.trim();
        if (patternTrimmed.toLowerCase() === addressTrimmed.toLowerCase()) {
          return true;
        }
        try {
          return new RegExp(patternTrimmed, "i").test(addressTrimmed);
        } catch {
          return false;
        }
      };

      // API 客户端
      const createClient = (token) => {
        const client = { token };
        const request = async (path, { method = "GET", body } = {}) => {
          const response = await fetch(path, {
            method,
            headers: { "Content-Type": "application/json", Authorization: `tma ${client.token}` },
            body: body ? JSON.stringify(body) : undefined,
          });
          const data = await response.json();
          if (data.error) throw new Error(data.error);
          return data;
        };
        return {
          setToken: (v) => (client.token = v || ""),
          addAddress: (address, type) => request("/api/address/add", { method: "POST", body: { address, type } }),
          removeAddress: (address, type) => request("/api/address/remove", { method: "POST", body: { address, type } }),
          loadAddress: () => request("/api/address/list"),
          clearSummaryCache: () => request("/api/summary/clear", { method: "POST" }),
          deleteMail: (id) => request(`/api/mails/${id}`, { method: "DELETE" }),
          loadMails: (limit, cursor) => {
            const p = new URLSearchParams();
            if (limit) p.set("limit", limit);
            if (cursor) p.set("cursor", cursor);
            return request(`/api/mails/list?${p}`);
          },
          loadMailDetail: (id) => request(`/api/mails/${id}`),
          loadMailSummary: (id) => request(`/api/mails/${id}/summary`),
          refreshMailSummary: (id) => request(`/api/mails/${id}/summary/refresh`, { method: "POST" }),
        };
      };

      const { createApp, reactive, computed, watch, onMounted, onUnmounted, nextTick, toRefs } = Vue;

      createApp({
        setup() {
          const params = new URLSearchParams(window.location.search);
          const state = reactive({
            func: params.get("func") || "mails",
            mode: params.get("mode") || "block",
            tipMessage: "",
            loading: false,
            clearingSummaryCache: false,
            menuOpen: false,
            cursor: null,
            hasMore: false,
            mailList: [],
            currentMail: null,
            mailViewMode: "html",
            summary: { text: "", source: "", loading: false, error: "" },
            inputAddress: "",
            sendMail: { from: "", to: "", subject: "", text: "" },
            lists: { block: [], white: [] },
            testList: [],
            showScrollTop: false,
            deletingMail: false,
          });

          const client = createClient("");
          const menuItems = [
            { value: "mails", label: "邮件列表" },
            { value: "list", label: "地址管理" },
            { value: "sendmail", label: "发送邮件" },
          ];

          const placeholders = {
            block: "输入正则 (如: .*@spam.com)",
            white: "输入白名单正则",
            test: "输入邮箱测试匹配",
          };

          const resetSummary = () => Object.assign(state.summary, { text: "", source: "", loading: false, error: "" });
          const addresses = computed(() => (state.mode === "test" ? state.testList : (state.lists[state.mode] ?? [])));
          const inputPlaceholder = computed(() => placeholders[state.mode] ?? placeholders.block);
          const summaryLabel = computed(() => ({ cache: "缓存", generated: "实时生成", unavailable: "未启用", error: "失败" })[state.summary.source] ?? "");
          const textMailHtml = computed(() => (state.currentMail?.text ? linkify(state.currentMail.text) : ""));

          const dateFormatter = new Intl.DateTimeFormat("zh-CN", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
          });
          const formatFullDateTime = (v) => {
            if (!v) return "-";
            const date = new Date(v);
            return isNaN(date.getTime()) ? "-" : dateFormatter.format(date).replace(/\//g, "-");
          };

          const syncFrameHeight = () => {
            const frame = document.getElementById("mail-content-frame");
            if (!frame) return;
            try {
              const doc = frame.contentDocument || frame.contentWindow?.document;
              if (doc) frame.style.height = `${Math.max(doc.body?.scrollHeight || 0, doc.documentElement?.scrollHeight || 0, 200) + 20}px`;
            } catch {
              frame.style.height = "500px";
            }
          };

          const toggleMenu = () => (state.menuOpen = !state.menuOpen);

          const switchPage = (value) => {
            if (value === "mail-detail") return;
            state.menuOpen = false;
            resetSummary();
            state.currentMail = null;
            state.mailViewMode = "html";
            state.func = value;
            if (value === "sendmail") state.tipMessage = "";
          };

          const ensureSummary = async () => {
            if (!state.currentMail || state.summary.loading || state.summary.text) return;
            state.summary.loading = true;
            state.summary.error = "";
            try {
              const { source, text } = await client.loadMailSummary(state.currentMail.id);
              state.summary.source = source;
              if (source === "error" || source === "unavailable") {
                state.summary.error = text;
                state.summary.text = "";
              } else {
                state.summary.text = text;
              }
            } catch (e) {
              state.summary.error = safeError(e);
              state.summary.source = "error";
            } finally {
              state.summary.loading = false;
            }
          };

          const refreshSummary = async () => {
            state.summary.loading = true;
            state.summary.error = "";
            try {
              const { source, text } = await client.refreshMailSummary(state.currentMail.id);
              state.summary.source = source;
              if (source === "error" || source === "unavailable") {
                state.summary.error = text;
              } else {
                state.summary.text = text;
                state.tipMessage = "AI 摘要已更新";
              }
            } catch (e) {
              state.summary.error = safeError(e);
            } finally {
              state.summary.loading = false;
            }
          };

          const loadAddress = async () => {
            try {
              const data = await client.loadAddress();
              state.lists.block = data.block || [];
              state.lists.white = data.white || [];
              state.tipMessage = "";
            } catch (e) {
              state.tipMessage = `ERROR: ${safeError(e)}`;
            }
          };

          const loadMails = async (reset = false) => {
            if (!reset && state.loading) return;
            state.loading = true;
            if (reset) {
              state.mailList = [];
              state.cursor = null;
            }
            try {
              const { mails, cursor } = await client.loadMails(50, reset ? null : state.cursor);
              state.mailList.push(...(mails || []));
              state.cursor = cursor ?? null;
              state.hasMore = !!cursor;
              state.tipMessage = "";
            } catch (e) {
              state.tipMessage = `ERROR: ${safeError(e)}`;
            } finally {
              state.loading = false;
            }
          };

          const loadMoreMails = () => loadMails(false);
          const refreshMails = () => loadMails(true);

          const clearSummaryCache = async () => {
            if (!confirm("清除所有 AI 摘要缓存？")) return;
            state.clearingSummaryCache = true;
            try {
              const { deleted } = await client.clearSummaryCache();
              state.tipMessage = `已清除 ${deleted} 条缓存`;
              resetSummary();
            } catch (e) {
              state.tipMessage = `ERROR: ${safeError(e)}`;
            } finally {
              state.clearingSummaryCache = false;
            }
          };

          const setMailViewMode = async (mode) => {
            if (state.mailViewMode === mode) {
              if (mode === "html") {
                await nextTick();
                syncFrameHeight();
              }
              if (mode === "summary" && state.currentMail && confirm("重新生成 AI 摘要？")) await refreshSummary();
              return;
            }
            state.mailViewMode = mode;
          };

          const viewMail = async (id) => {
            state.loading = true;
            try {
              state.currentMail = await client.loadMailDetail(id);
              state.func = "mail-detail";
              resetSummary();
              state.mailViewMode = state.currentMail.html ? "html" : state.currentMail.text ? "text" : "summary";
              state.tipMessage = "";
              window.scrollTo({ top: 0 });
            } catch (e) {
              state.tipMessage = `ERROR: ${safeError(e)}`;
            } finally {
              state.loading = false;
            }
          };

          const backToList = () => {
            state.currentMail = null;
            state.func = "mails";
            state.tipMessage = "";
          };

          const deleteCurrentMail = async () => {
            if (!confirm("确定删除？")) return;
            state.deletingMail = true;
            try {
              await client.deleteMail(state.currentMail.id);
              state.mailList = state.mailList.filter((m) => m.id !== state.currentMail.id);
              backToList();
              state.tipMessage = "邮件已删除";
            } catch (e) {
              state.tipMessage = `ERROR: ${safeError(e)}`;
            } finally {
              state.deletingMail = false;
            }
          };

          const addAddress = async () => {
            const val = state.inputAddress.trim();
            if (!val) return;
            try {
              await client.addAddress(val, state.mode);
              if (state.mode !== "test") state.lists[state.mode]?.push(val);
              state.inputAddress = "";
              state.tipMessage = "";
            } catch (e) {
              state.tipMessage = `ERROR: ${safeError(e)}`;
            }
          };

          const removeAddress = async (index) => {
            const list = state.lists[state.mode];
            const target = list?.[index];
            if (!target) return;
            try {
              await client.removeAddress(target, state.mode);
              list.splice(index, 1);
            } catch (e) {
              state.tipMessage = `ERROR: ${safeError(e)}`;
            }
          };

          const testAddress = () => {
            const val = state.inputAddress.trim();
            if (!val) {
              state.testList = [];
              return;
            }
            const res = [];
            state.lists.block.forEach((p) => {
              if (matchPattern(p, val)) {
                res.push({ address: p, result: "block" });
              }
            });
            state.lists.white.forEach((p) => {
              if (matchPattern(p, val)) {
                res.push({ address: p, result: "white" });
              }
            });
            state.testList = res;

            if (res.length === 0) {
              state.tipMessage = `地址 "${val}" 未匹配任何规则`;
            } else {
              const blockCount = res.filter((r) => r.result === "block").length;
              const whiteCount = res.filter((r) => r.result === "white").length;
              if (whiteCount > 0) {
                state.tipMessage = `地址 "${val}" 匹配 ${whiteCount} 个白名单规则${blockCount > 0 ? ` 和 ${blockCount} 个黑名单规则` : ""} (白名单优先)`;
              } else {
                state.tipMessage = `地址 "${val}" 匹配 ${blockCount} 个黑名单规则`;
              }
            }
          };

          const scrollToTop = () => window.scrollTo({ top: 0, behavior: "smooth" });
          let scrollTimer;
          const handleScroll = () => {
            if (scrollTimer) return;
            scrollTimer = setTimeout(() => {
              state.showScrollTop = window.scrollY > 300;
              scrollTimer = null;
            }, 100);
          };

          watch(
            () => state.mode,
            () => {
              state.inputAddress = "";
              if (state.mode === "test") state.testList = [];
            },
          );

          watch(
            () => state.inputAddress,
            (newVal) => {
              if (state.mode === "test") {
                testAddress();
              }
            },
          );
          watch(
            () => state.mailViewMode,
            async (m) => {
              if (m === "html") {
                await nextTick();
                syncFrameHeight();
              } else if (m === "summary") ensureSummary();
            },
          );
          watch(
            () => state.func,
            (v) => {
              state.menuOpen = false;
              window.scrollTo({ top: 0 });
              state.showScrollTop = false;
              if (v === "list" && !state.lists.block.length) loadAddress();
              if (v === "mails" && !state.mailList.length) loadMails(true);
            },
          );

          onMounted(async () => {
            window.addEventListener("scroll", handleScroll, { passive: true });
            const tg = window.Telegram?.WebApp;
            if (tg) {
              client.setToken(tg.initData);
              tg.ready?.();
            }
            state.func === "mails" ? loadMails(true) : state.func === "list" && loadAddress();
          });

          onUnmounted(() => window.removeEventListener("scroll", handleScroll));

          return {
            ...toRefs(state),
            menuItems,
            addresses,
            inputPlaceholder,
            summaryLabel,
            textMailHtml,
            formatFullDateTime,
            syncFrameHeight,
            toggleMenu,
            switchPage,
            loadMoreMails,
            refreshMails,
            clearSummaryCache,
            setMailViewMode,
            viewMail,
            backToList,
            deleteCurrentMail,
            addAddress,
            removeAddress,
            testAddress,
            scrollToTop,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
