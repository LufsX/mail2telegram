<!DOCTYPE html>
<html lang="zh-cn" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mail2telegram</title>
    <script src="https://cors.isteed.cc/https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
      :root {
        color-scheme: light;
        --c-bg: #f4f5f7;
        --c-surface: #ffffff;
        --c-surface-2: #f0f4f8;
        --c-text: #1f2933;
        --c-text-soft: #334155;
        --c-text-muted: #7b8794;
        --c-border: #d9e2ec;
        --c-border-soft: #e4ebf5;
        --c-primary: #0088cc;
        --c-primary-hover: #0b6fa4;
        --c-danger: #e12d39;
        --c-danger-hover: #c81e32;
        --c-tip-bg: #fff8e1;
        --c-tip-border: #f6c453;
        --c-tip-text: #8d5d0b;
      }

      :root[data-theme="dark"] {
        color-scheme: dark;
        --c-bg: #0f172a;
        --c-surface: #111827;
        --c-surface-2: #1e293b;
        --c-text: #e2e8f0;
        --c-text-soft: #cbd5f5;
        --c-text-muted: #94a3b8;
        --c-border: #1f2937;
        --c-border-soft: #273449;
        --c-primary: #2bb8ff;
        --c-primary-hover: #5ecbff;
        --c-danger: #f87171;
        --c-danger-hover: #dc2626;
        --c-tip-bg: rgba(255, 214, 102, 0.08);
        --c-tip-border: rgba(255, 214, 102, 0.4);
        --c-tip-text: #facc15;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 16px;
        background: var(--c-bg);
        color: var(--c-text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
        line-height: 1.6;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .app {
        max-width: 840px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .panel {
        border: 1px solid var(--c-border);
        border-radius: 1px;
        background: var(--c-surface);
        overflow: hidden;
      }

      .panel__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding: 20px 24px 12px;
        border-bottom: 1px solid var(--c-border-soft);
        background: var(--c-surface);
      }

      .panel__header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--c-text);
      }

      .panel__body {
        padding: 24px;
      }

      button {
        padding: 8px 14px;
        border-radius: 1px;
        border: 1px solid var(--c-border);
        background: transparent;
        color: var(--c-text);
        font-size: 0.875rem;
        font-family: inherit;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      button:hover {
        background: var(--c-surface-2);
      }

      button:active {
        transform: translateY(1px);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      button.primary {
        background: var(--c-primary);
        border-color: var(--c-primary);
        color: #ffffff;
      }

      button.primary:hover {
        background: var(--c-primary-hover);
        border-color: var(--c-primary-hover);
      }

      button.danger {
        color: var(--c-danger);
        border-color: var(--c-danger);
      }

      button.danger:hover {
        background: var(--c-danger-hover);
        border-color: var(--c-danger-hover);
        color: #ffffff;
      }

      button.full {
        width: 100%;
        margin-top: 16px;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 8px 12px;
        border-radius: 1px;
        border: 1px solid var(--c-border);
        background: var(--c-surface);
        font-size: 0.875rem;
        font-family: ui-monospace, "SF Mono", Menlo, monospace;
        color: var(--c-text-soft);
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--c-primary);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      select {
        width: auto;
      }

      .tip {
        margin: 0 0 16px;
        padding: 12px 16px;
        border-radius: 1px;
        border: 1px solid var(--c-tip-border);
        background: var(--c-tip-bg);
        color: var(--c-tip-text);
        font-size: 0.875rem;
      }

      .tip.error {
        background: rgba(225, 45, 57, 0.12);
        border-color: rgba(225, 45, 57, 0.4);
        color: var(--c-danger);
      }

      .empty {
        text-align: center;
        color: var(--c-text-muted);
        padding: 32px 0;
        font-size: 0.9rem;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
      }

      .table th,
      .table td {
        padding: 14px 16px;
        text-align: left;
        border-bottom: 1px solid var(--c-border-soft);
        font-size: 0.875rem;
      }

      .table thead th {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--c-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .table tbody tr:hover {
        background: var(--c-surface-2);
      }

      .table__action {
        width: 90px;
        text-align: right;
        white-space: nowrap;
      }

      .subject {
        color: var(--c-text-soft);
        font-weight: 500;
        word-break: break-word;
      }

      .mail-meta {
        border: 1px solid var(--c-border);
        border-radius: 1px;
        background: var(--c-surface);
        margin-bottom: 24px;
        padding: 8px 16px;
      }

      .mail-meta__row {
        display: grid;
        grid-template-columns: 80px 1fr;
        gap: 8px 16px;
        align-items: baseline;
        padding: 10px 0;
        border-bottom: 1px solid var(--c-border-soft);
      }

      .mail-meta__row:last-child {
        border-bottom: none;
      }

      .mail-meta__label {
        font-size: 0.8125rem;
        color: var(--c-text-muted);
        font-weight: 600;
      }

      .mail-meta__value {
        font-family: ui-monospace, "SF Mono", Menlo, monospace;
        font-size: 0.875rem;
        color: var(--c-text-soft);
        word-break: break-all;
      }

      .mail-subject {
        margin: 16px 0 24px;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--c-text);
        line-height: 1.4;
      }

      .mail-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
      }

      .mail-tabs button {
        background: var(--c-surface-2);
        border-color: transparent;
        color: var(--c-text-soft);
      }

      .mail-tabs button.active {
        background: var(--c-primary);
        border-color: var(--c-primary);
        color: #ffffff;
      }

      .mail-view {
        border: 1px solid var(--c-border);
        border-radius: 1px;
        padding: 16px;
        background: var(--c-surface-2);
        max-height: 600px;
        overflow: auto;
      }

      .mail-view--html {
        border: 1px solid var(--c-border);
        border-radius: 1px;
        padding: 0;
        overflow: visible;
        background: var(--c-surface);
        width: 100%;
        max-height: none;
      }

      .mail-view pre,
      .mail-view .mail-text {
        margin: 0;
        font-family: ui-monospace, "SF Mono", Menlo, monospace;
        font-size: 0.875rem;
        line-height: 1.7;
        color: var(--c-text-soft);
        white-space: pre-wrap;
        word-break: break-word;
      }

      .mail-view--html iframe {
        width: 100%;
        border: none;
        display: block;
        background: var(--c-surface);
        margin: 0;
      }

      .mail-view a {
        color: var(--c-primary);
        text-decoration: underline;
        word-break: break-all;
      }

      .mail-view a:hover {
        color: var(--c-primary-hover);
      }

      .mail-view .empty {
        padding: 24px 0;
      }

      .summary-meta {
        margin-top: 12px;
        font-size: 0.75rem;
        color: var(--c-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .input-row {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 16px;
      }

      .input-row input {
        flex: 1;
      }

      .form-label {
        width: 80px;
        color: var(--c-text-muted);
        font-size: 0.8125rem;
        display: inline-flex;
        align-items: center;
      }

      .input-row--textarea {
        align-items: flex-start;
      }

      .input-row--textarea .form-label {
        padding-top: 8px;
      }

      .address-list {
        list-style: none;
        margin: 0;
        padding: 0;
        border: 1px solid var(--c-border);
        border-radius: 1px;
        overflow: hidden;
      }

      .address-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--c-border-soft);
        background: var(--c-surface);
        font-family: ui-monospace, "SF Mono", Menlo, monospace;
        font-size: 0.875rem;
        color: var(--c-text-soft);
      }

      .address-item:last-child {
        border-bottom: none;
      }

      .badge {
        padding: 4px 8px;
        border-radius: 1px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .badge.block {
        background: var(--c-danger);
        color: #ffffff;
      }

      .badge.white {
        background: #22c55e;
        color: #052e16;
      }

      .scroll-top {
        position: fixed;
        right: max(16px, calc((100vw - 840px) / 2 + 24px));
        bottom: 80px;
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.2);
        z-index: 999;
      }

      .scroll-top:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 36px rgba(15, 23, 42, 0.24);
      }

      @media (max-width: 720px) {
        body {
          padding: 12px;
        }

        .panel__header {
          padding: 16px 20px 10px;
        }

        .panel__body {
          padding: 20px;
        }

        button {
          padding: 6px 12px;
        }

        .table__action {
          width: 70px;
        }

        .mail-meta__row {
          grid-template-columns: 70px 1fr;
        }

        .mail-subject {
          font-size: 1.3rem;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 0;
        }

        .app {
          max-width: none;
        }

        .panel {
          border-radius: 0;
        }

        .input-row {
          flex-direction: column;
          align-items: stretch;
        }

        .input-row button {
          width: 100%;
        }

        .mail-tabs {
          width: 100%;
        }

        .mail-tabs button {
          flex: 1 1 30%;
        }

        .table {
          font-size: 0.8125rem;
        }

        .table th,
        .table td {
          padding: 12px 8px;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="app">
      <section v-if="func === 'mails'" class="panel">
        <header class="panel__header">
          <h3>邮件列表</h3>
          <button @click="refreshMails" :disabled="loading">刷新</button>
        </header>
        <div class="panel__body">
          <p v-if="tipMessage" :class="['tip', { error: tipMessage.startsWith('ERROR') }]">{{ tipMessage }}</p>
          <div v-if="loading" class="empty">加载中...</div>
          <template v-else>
            <div v-if="!mailList.length" class="empty">暂无邮件</div>
            <table v-else class="table">
              <thead>
                <tr>
                  <th>标题</th>
                  <th class="table__action">操作</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="mail in mailList" :key="mail.id">
                  <td class="subject">{{ mail.subject || '(无标题)' }}</td>
                  <td class="table__action">
                    <button class="primary" @click="viewMail(mail.id)">查看</button>
                  </td>
                </tr>
              </tbody>
            </table>
            <button v-if="hasMore" class="primary full" @click="loadMoreMails">加载更多</button>
          </template>
        </div>
      </section>

      <section v-if="func === 'mail-detail' && currentMail" class="panel">
        <header class="panel__header">
          <h3>邮件详情</h3>
          <button @click="backToList">← 返回列表</button>
        </header>
        <div class="panel__body">
          <div class="mail-meta">
            <div class="mail-meta__row">
              <span class="mail-meta__label">发件人</span>
              <span class="mail-meta__value">{{ currentMail.from }}</span>
            </div>
            <div class="mail-meta__row">
              <span class="mail-meta__label">收件人</span>
              <span class="mail-meta__value">{{ currentMail.to }}</span>
            </div>
            <div v-if="currentMail.receivedAt" class="mail-meta__row">
              <span class="mail-meta__label">收件时间</span>
              <span class="mail-meta__value">{{ formatFullDateTime(currentMail.receivedAt) }}</span>
            </div>
          </div>

          <h2 class="mail-subject">{{ currentMail.subject || '(无标题)' }}</h2>

          <div class="mail-tabs">
            <button v-if="currentMail.html" :class="{ active: mailViewMode === 'html' }" @click="setMailViewMode('html')">HTML 正文</button>
            <button v-if="currentMail.text" :class="{ active: mailViewMode === 'text' }" @click="setMailViewMode('text')">纯文本</button>
            <button :class="{ active: mailViewMode === 'summary' }" @click="setMailViewMode('summary')">AI 摘要</button>
          </div>

          <div v-if="mailViewMode === 'html' && currentMail.html" class="mail-view--html">
            <iframe id="mail-content-frame" :srcdoc="currentMail.html" title="邮件正文预览" @load="syncFrameHeight"></iframe>
          </div>
          <div v-else-if="mailViewMode === 'text' && currentMail.text" class="mail-view">
            <div class="mail-text" v-html="textMailHtml"></div>
          </div>
          <div v-else-if="mailViewMode === 'summary'" class="mail-view">
            <div v-if="summary.loading" class="empty">摘要生成中...</div>
            <div v-else-if="summary.error" class="empty">{{ summary.error }}</div>
            <template v-else-if="summary.text">
              <pre>{{ summary.text }}</pre>
              <div v-if="summaryLabel" class="summary-meta">来源：{{ summaryLabel }}</div>
            </template>
            <div v-else class="empty">点击“AI 摘要”生成内容</div>
          </div>
          <div v-else class="mail-view">
            <div class="empty">(正文为空)</div>
          </div>
        </div>
      </section>

      <section v-if="func === 'list'" class="panel">
        <header class="panel__header">
          <h3>地址列表管理</h3>
          <select v-model="mode" aria-label="选择列表类型">
            <option value="block">黑名单</option>
            <option value="white">白名单</option>
            <option value="test">测试地址</option>
          </select>
        </header>
        <div class="panel__body">
          <p v-if="tipMessage" :class="['tip', { error: tipMessage.startsWith('ERROR') }]">{{ tipMessage }}</p>

          <template v-if="mode !== 'test'">
            <div class="input-row">
              <input v-model="inputAddress" :placeholder="inputPlaceholder" @keyup.enter="addAddress" aria-label="地址输入" />
              <button class="primary" @click="addAddress">添加</button>
            </div>
            <ul v-if="addresses.length" class="address-list">
              <li v-for="(address, index) in addresses" :key="address + index" class="address-item">
                <span>{{ address }}</span>
                <button class="danger" @click="removeAddress(index)">删除</button>
              </li>
            </ul>
            <div v-else class="empty">暂无地址</div>
          </template>

          <template v-else>
            <div class="input-row">
              <input v-model="inputAddress" :placeholder="inputPlaceholder" @keyup.enter="testAddress" aria-label="测试地址输入" />
              <button class="primary" @click="testAddress">测试</button>
            </div>
            <ul v-if="addresses.length" class="address-list">
              <li v-for="(item, index) in addresses" :key="item.address + index" class="address-item">
                <span>{{ item.address }}</span>
                <span :class="['badge', item.result]">{{ item.result }}</span>
              </li>
            </ul>
            <div v-else class="empty">输入地址后点击测试</div>
          </template>
        </div>
      </section>

      <section v-if="func === 'sendmail'" class="panel">
        <header class="panel__header">
          <h3>发送邮件</h3>
        </header>
        <div class="panel__body">
          <p v-if="tipMessage" :class="['tip', { error: tipMessage.startsWith('ERROR') }]">{{ tipMessage }}</p>
          <div class="input-row">
            <label class="form-label">发件人</label>
            <input type="email" v-model="sendMail.from" placeholder="sender@example.com" aria-label="发件人" />
          </div>
          <div class="input-row">
            <label class="form-label">收件人</label>
            <input type="email" v-model="sendMail.to" placeholder="recipient@example.com" aria-label="收件人" />
          </div>
          <div class="input-row">
            <label class="form-label">标题</label>
            <input type="text" v-model="sendMail.subject" placeholder="邮件标题" aria-label="邮件标题" />
          </div>
          <div class="input-row input-row--textarea">
            <label class="form-label">正文</label>
            <textarea v-model="sendMail.text" placeholder="邮件正文" aria-label="邮件正文"></textarea>
          </div>
          <button class="primary full">发送</button>
        </div>
      </section>

      <button v-if="showScrollTop" class="scroll-top primary" @click="scrollToTop" aria-label="返回顶部">↑ 返回顶部</button>
    </div>

    <script>
      const applyTheme = (scheme) => {
        document.documentElement.setAttribute("data-theme", scheme === "dark" ? "dark" : "light");
      };

      let themeBound = false;

      const bindTelegramTheme = () => {
        if (themeBound) return true;
        const tg = window.Telegram?.WebApp;
        if (!tg) return false;
        applyTheme(tg.colorScheme);
        tg.onEvent?.("themeChanged", () => applyTheme(tg.colorScheme));
        themeBound = true;
        return true;
      };

      const initTheme = () => {
        if (bindTelegramTheme()) return;
        const media = window.matchMedia("(prefers-color-scheme: dark)");
        const sync = () => applyTheme(media.matches ? "dark" : "light");
        sync();
        if (typeof media.addEventListener === "function") {
          media.addEventListener("change", sync);
        } else if (typeof media.addListener === "function") {
          media.addListener(sync);
        }
      };

      initTheme();

      const safeError = (error) => (error instanceof Error ? error.message : String(error ?? ""));

      const escapeHtml = (value) =>
        String(value ?? "").replace(
          /[&<>"']/g,
          (char) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[char])
        );

      const linkify = (text) => {
        if (!text) return "";
        const pattern = /<((?:https?:\/\/|mailto:)[^>\s]+)>|((?:https?:\/\/|mailto:)[^\s<>"']+)/gi;
        let lastIndex = 0;
        let output = "";
        text.replace(pattern, (match, bracketUrl, plainUrl, index) => {
          output += escapeHtml(text.slice(lastIndex, index));
          const url = bracketUrl || plainUrl;
          if (url) {
            const safeUrl = escapeHtml(url);
            const label = bracketUrl ? `&lt;${safeUrl}&gt;` : safeUrl;
            output += `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${label}</a>`;
          }
          lastIndex = index + match.length;
          return match;
        });
        output += escapeHtml(text.slice(lastIndex));
        return output.replace(/\r?\n/g, "<br />");
      };

      const matchPattern = (pattern, address) => {
        if (!pattern || !address) return false;
        if (pattern.toLowerCase() === address.toLowerCase()) return true;
        try {
          return new RegExp(pattern, "i").test(address);
        } catch (error) {
          return false;
        }
      };

      const createClient = (token) => {
        const client = { token };
        const request = async (path, { method = "GET", body } = {}) => {
          const response = await fetch(path, {
            method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `tma ${client.token}`,
            },
            body: body !== undefined ? JSON.stringify(body) : undefined,
          });
          const data = await response.json();
          if (data.error) throw new Error(data.error);
          return data;
        };

        return {
          setToken: (value) => {
            client.token = value || "";
          },
          addAddress: (address, type) => request("/api/address/add", { method: "POST", body: { address, type } }),
          removeAddress: (address, type) => request("/api/address/remove", { method: "POST", body: { address, type } }),
          loadAddress: () => request("/api/address/list"),
          loadMails: (limit, cursor) => {
            const params = new URLSearchParams();
            if (limit) params.set("limit", limit);
            if (cursor) params.set("cursor", cursor);
            const query = params.toString();
            return request(`/api/mails/list${query ? `?${query}` : ""}`);
          },
          loadMailDetail: (id) => request(`/api/mails/${id}`),
          loadMailSummary: (id) => request(`/api/mails/${id}/summary`),
        };
      };

      const { createApp, reactive, computed, watch, onMounted, onUnmounted, nextTick, toRefs } = Vue;

      createApp({
        setup() {
          const params = new URLSearchParams(window.location.search);
          const state = reactive({
            func: params.get("func") || "list",
            mode: params.get("mode") || "block",
            tipMessage: "",
            loading: false,
            cursor: null,
            hasMore: false,
            mailList: [],
            currentMail: null,
            mailViewMode: "html",
            summary: { text: "", source: "", loading: false, error: "" },
            inputAddress: "",
            sendMail: { from: "", to: "", subject: "", text: "" },
            lists: { block: [], white: [] },
            testList: [],
            showScrollTop: false,
          });

          const client = createClient("");

          const placeholders = {
            block: "新建黑名单正则",
            white: "新建白名单正则",
            test: "测试地址",
          };

          const summaryLabels = {
            cache: "来自缓存",
            generated: "实时生成",
            unavailable: "功能未启用",
            error: "生成失败",
          };

          const resetSummary = () => {
            Object.assign(state.summary, { text: "", source: "", loading: false, error: "" });
          };

          const addresses = computed(() => (state.mode === "test" ? state.testList : state.lists[state.mode] ?? []));
          const inputPlaceholder = computed(() => placeholders[state.mode] ?? placeholders.block);
          const summaryLabel = computed(() => summaryLabels[state.summary.source] ?? "");
          const textMailHtml = computed(() => (state.currentMail?.text ? linkify(state.currentMail.text) : ""));

          const formatFullDateTime = (value) => {
            if (!value) return "-";
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return "-";
            const pad = (num) => String(num).padStart(2, "0");
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
          };

          const syncFrameHeight = () => {
            const frame = document.getElementById("mail-content-frame");
            if (!frame) return;
            try {
              const doc = frame.contentDocument || frame.contentWindow?.document;
              if (!doc) return;
              const height = Math.max(doc.body?.scrollHeight || 0, doc.documentElement?.scrollHeight || 0, 200);
              frame.style.height = `${height}px`;
            } catch (error) {
              frame.style.height = "500px";
            }
          };

          const ensureSummary = async () => {
            if (!state.currentMail || state.summary.loading || state.summary.text) return;
            state.summary.loading = true;
            state.summary.error = "";
            try {
              const { source, text } = await client.loadMailSummary(state.currentMail.id);
              state.summary.source = source;
              if (source === "error" || source === "unavailable") {
                state.summary.error = text;
                state.summary.text = "";
              } else {
                state.summary.text = text;
              }
            } catch (error) {
              state.summary.error = safeError(error);
              state.summary.source = "error";
              state.summary.text = "";
            } finally {
              state.summary.loading = false;
            }
          };

          const loadAddress = async () => {
            try {
              const { block = [], white = [] } = await client.loadAddress();
              state.lists.block = block;
              state.lists.white = white;
              state.tipMessage = "";
            } catch (error) {
              state.tipMessage = `ERROR: ${safeError(error)}`;
            }
          };

          const loadMails = async (reset = false) => {
            if (!reset && state.loading) return;
            state.loading = true;
            if (reset) {
              state.mailList = [];
              state.cursor = null;
              state.hasMore = false;
            }
            try {
              const { mails = [], cursor } = await client.loadMails(50, reset ? null : state.cursor);
              state.mailList.push(...mails);
              state.cursor = cursor ?? null;
              state.hasMore = Boolean(cursor);
              state.tipMessage = "";
            } catch (error) {
              state.tipMessage = `ERROR: ${safeError(error)}`;
            } finally {
              state.loading = false;
            }
          };

          const loadMoreMails = () => loadMails(false);
          const refreshMails = () => loadMails(true);

          const setMailViewMode = async (mode) => {
            if (state.mailViewMode === mode) {
              if (mode === "html") {
                await nextTick();
                syncFrameHeight();
              }
              if (mode === "summary") ensureSummary();
              return;
            }
            state.mailViewMode = mode;
          };

          const viewMail = async (id) => {
            if (!id) return;
            state.loading = true;
            try {
              state.currentMail = await client.loadMailDetail(id);
              state.func = "mail-detail";
              resetSummary();
              if (state.currentMail.html) {
                state.mailViewMode = "html";
              } else if (state.currentMail.text) {
                state.mailViewMode = "text";
              } else {
                state.mailViewMode = "summary";
              }
              state.tipMessage = "";
            } catch (error) {
              state.tipMessage = `ERROR: ${safeError(error)}`;
            } finally {
              state.loading = false;
            }
          };

          const backToList = () => {
            resetSummary();
            state.currentMail = null;
            state.mailViewMode = "html";
            state.func = "mails";
          };

          const addAddress = async () => {
            const address = state.inputAddress.trim();
            if (!address) return;
            try {
              await client.addAddress(address, state.mode);
              if (state.mode !== "test") {
                state.lists[state.mode]?.push(address);
              }
              state.inputAddress = "";
              state.tipMessage = "";
            } catch (error) {
              state.tipMessage = `ERROR: ${safeError(error)}`;
            }
          };

          const removeAddress = async (index) => {
            const list = state.lists[state.mode];
            const target = list?.[index];
            if (!target) return;
            try {
              await client.removeAddress(target, state.mode);
              list.splice(index, 1);
              state.tipMessage = "";
            } catch (error) {
              state.tipMessage = `ERROR: ${safeError(error)}`;
            }
          };

          const testAddress = () => {
            const address = state.inputAddress.trim();
            if (!address) {
              state.testList = [];
              return;
            }
            const results = [];
            for (const pattern of state.lists.block) {
              if (matchPattern(pattern, address)) results.push({ address: pattern, result: "block" });
            }
            for (const pattern of state.lists.white) {
              if (matchPattern(pattern, address)) results.push({ address: pattern, result: "white" });
            }
            state.testList = results;
          };

          const scrollToTop = () => window.scrollTo({ top: 0, behavior: "smooth" });
          const handleScroll = () => {
            state.showScrollTop = window.scrollY > 320 && state.func === "mail-detail";
          };

          watch(
            () => state.mode,
            () => {
              state.inputAddress = "";
              if (state.mode === "test") state.testList = [];
            }
          );

          watch(
            () => state.mailViewMode,
            async (mode) => {
              if (mode === "html") {
                await nextTick();
                syncFrameHeight();
              } else if (mode === "summary") {
                ensureSummary();
              }
            }
          );

          watch(
            () => state.func,
            (value) => {
              handleScroll();
              if (value === "list" && !state.lists.block.length && !state.lists.white.length) {
                loadAddress();
              }
              if (value === "mails" && !state.mailList.length) {
                loadMails(true);
              }
            }
          );

          onMounted(async () => {
            handleScroll();
            window.addEventListener("scroll", handleScroll, { passive: true });

            bindTelegramTheme();
            const tg = window.Telegram?.WebApp;
            client.setToken(tg?.initData ?? "");
            tg?.ready?.();

            if (state.func === "mails") {
              await loadMails(true);
            } else if (state.func === "list") {
              await loadAddress();
            }
          });

          onUnmounted(() => {
            window.removeEventListener("scroll", handleScroll);
          });

          return {
            ...toRefs(state),
            addresses,
            inputPlaceholder,
            summaryLabel,
            textMailHtml,
            formatFullDateTime,
            syncFrameHeight,
            loadMoreMails,
            refreshMails,
            setMailViewMode,
            viewMail,
            backToList,
            addAddress,
            removeAddress,
            testAddress,
            scrollToTop,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
