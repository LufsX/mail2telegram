<!DOCTYPE html>
<html lang="zh-cn" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mail2telegram</title>
    <script src="https://cors.isteed.cc/https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
      :root {
        color-scheme: light;
        --bg: #fafafa;
        --surface: #fff;
        --surface-secondary: #f5f5f5;
        --text: #222;
        --text-strong: #111;
        --text-subtle: #333;
        --text-muted: #666;
        --text-faint: #999;
        --border: #e5e5e5;
        --border-soft: #f5f5f5;
        --button-bg: #fff;
        --button-border: #ddd;
        --button-hover-border: #999;
        --button-hover-bg: #f9f9f9;
        --button-active-bg: #f0f0f0;
        --input-bg: #fff;
        --input-border: #ddd;
        --tip-bg: #fff3cd;
        --tip-border: #ffc107;
        --tip-text: #856404;
        --tip-error-bg: #f8d7da;
        --tip-error-border: #dc3545;
        --tip-error-text: #721c24;
        --table-header-text: #666;
        --badge-white-bg: #28a745;
        --badge-white-text: #fff;
        --badge-block-bg: #dc3545;
        --badge-block-text: #fff;
        --empty-text: #999;
        --loading-text: #666;
        --mail-content-bg: #fafafa;
        --mail-frame-bg: #fff;
        --primary: #0088cc;
        --primary-hover: #006699;
        --primary-text: #fff;
        --danger: #dc3545;
        --danger-hover: #dc3545;
        --danger-text: #dc3545;
      }

      :root[data-theme="dark"] {
        color-scheme: dark;
        --bg: #000000;
        --surface: #000000;
        --surface-secondary: #1e293b;
        --text: #e2e8f0;
        --text-strong: #f9fafb;
        --text-subtle: #e2e8f0;
        --text-muted: #94a3b8;
        --text-faint: #94a3b8;
        --border: #1f2937;
        --border-soft: #24324a;
        --button-bg: #1f2937;
        --button-border: #334155;
        --button-hover-border: #60a5fa;
        --button-hover-bg: #273449;
        --button-active-bg: #334155;
        --input-bg: #0f172a;
        --input-border: #334155;
        --tip-bg: rgba(255, 193, 7, 0.12);
        --tip-border: #facc15;
        --tip-text: #facc15;
        --tip-error-bg: rgba(220, 53, 69, 0.15);
        --tip-error-border: #f87171;
        --tip-error-text: #fca5a5;
        --table-header-text: #94a3b8;
        --badge-white-bg: #22c55e;
        --badge-white-text: #052e16;
        --badge-block-bg: #ef4444;
        --badge-block-text: #fef2f2;
        --empty-text: #94a3b8;
        --loading-text: #94a3b8;
        --mail-content-bg: #fafafa;
        --mail-frame-bg: #fff;
        --primary: #2bb8ff;
        --primary-hover: #5ecbff;
        --primary-text: #fff;
        --danger: #f87171;
        --danger-hover: #dc2626;
        --danger-text: #f87171;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
        margin: 0;
        padding: 16px;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .container {
        max-width: 840px;
        margin: 0 auto;
        background: var(--surface);
        border: 1px solid var(--border);
        overflow: hidden;
        transition: background 0.2s ease, border-color 0.2s ease;
      }

      .section-header {
        padding: 24px 24px 16px;
        border-bottom: 1px solid var(--border);
        background: var(--surface);
      }

      .section-header h3 {
        margin: 0;
        font-size: 1.375rem;
        font-weight: 600;
        color: var(--text-strong);
        letter-spacing: -0.02em;
      }

      .section-content {
        padding: 24px;
      }

      .tip-message {
        padding: 12px 16px;
        margin: 0 0 16px;
        background: var(--tip-bg);
        border: 1px solid var(--tip-border);
        border-radius: 4px;
        color: var(--tip-text);
        font-size: 0.875rem;
      }

      .tip-message.error {
        background: var(--tip-error-bg);
        border-color: var(--tip-error-border);
        color: var(--tip-error-text);
      }

      /* Buttons */
      button {
        padding: 8px 16px;
        border: 1px solid var(--button-border);
        background: var(--button-bg);
        color: var(--text-subtle);
        font-size: 0.875rem;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 4px;
        font-weight: 500;
      }

      button:hover {
        border-color: var(--button-hover-border);
        background: var(--button-hover-bg);
      }

      button:active {
        background: var(--button-active-bg);
      }

      button.primary {
        background: var(--button-bg);
        color: var(--text-subtle);
        border-color: var(--button-border);
      }

      button.primary:hover {
        background: var(--button-hover-bg);
        border-color: var(--button-hover-border);
      }

      button.danger {
        color: var(--danger-text);
        border-color: var(--danger);
      }

      button.danger:hover {
        background: var(--danger-hover);
        color: var(--primary-text);
        border-color: var(--danger-hover);
      }

      button.full-width {
        width: 100%;
        margin-top: 16px;
      }

      .scroll-top-btn {
        position: fixed;
        right: max(16px, calc((100vw - 840px) / 2 + 24px));
        bottom: 80px;
        z-index: 1000;
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .scroll-top-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 36px rgba(15, 23, 42, 0.22);
      }

      /* Input & Select */
      input[type="text"],
      input[type="email"],
      select,
      textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--input-border);
        border-radius: 4px;
        font-size: 0.875rem;
        font-family: ui-monospace, "SF Mono", Menlo, monospace;
        color: var(--text-subtle);
        background: var(--input-bg);
        transition: border-color 0.2s, background 0.2s ease, color 0.2s ease;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
      }

      textarea {
        min-height: 100px;
        resize: vertical;
        font-family: ui-monospace, "SF Mono", Menlo, monospace;
        line-height: 1.5;
      }

      /* Mail List Table */
      .mail-list-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }

      .mail-list-table thead {
        border-bottom: 2px solid var(--border);
      }

      .mail-list-table th {
        padding: 12px 16px;
        text-align: left;
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--table-header-text);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .mail-list-table td {
        padding: 16px;
        border-bottom: 1px solid var(--border-soft);
        font-size: 0.875rem;
      }

      .mail-list-table tr:hover {
        background: var(--surface-secondary);
      }

      .mail-list-table .subject-cell {
        color: var(--text-subtle);
        font-weight: 500;
        word-break: break-word;
        line-height: 1.5;
      }

      .mail-list-table .action-cell {
        text-align: right;
        white-space: nowrap;
        vertical-align: top;
        width: 80px;
      }

      .mail-list-table th.action-cell {
        text-align: right;
      }

      /* Address List */
      .address-input-row {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .address-input-row input {
        flex: 1;
      }

      .address-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .address-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-soft);
        font-family: ui-monospace, "SF Mono", Menlo, monospace;
        font-size: 0.875rem;
      }

      .address-item:hover {
        background: var(--surface-secondary);
      }

      .address-item .address-text {
        flex: 1;
        color: var(--text-subtle);
        word-break: break-all;
      }

      .address-item .address-badge {
        margin-left: 12px;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .address-badge.block {
        background: var(--badge-block-bg);
        color: var(--badge-block-text);
      }

      .address-badge.white {
        background: var(--badge-white-bg);
        color: var(--badge-white-text);
      }

      /* Mail Detail */
      .mail-detail-meta {
        border-top: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        margin-bottom: 24px;
      }

      .mail-detail-meta-row {
        padding: 14px 0;
        display: grid;
        grid-template-columns: 80px 1fr;
        align-items: baseline;
        border-bottom: 1px solid var(--border-soft);
      }

      .mail-detail-meta-row:last-child {
        border-bottom: none;
      }

      .mail-detail-label {
        font-size: 0.8125rem;
        color: var(--text-muted);
        font-weight: 500;
      }

      .mail-detail-value {
        font-family: ui-monospace, "SF Mono", Menlo, monospace;
        font-size: 0.875rem;
        color: var(--text-subtle);
        word-break: break-all;
      }

      .mail-detail-subject {
        margin: 0 0 24px;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-strong);
        line-height: 1.4;
        word-break: break-word;
        letter-spacing: -0.02em;
      }

      .mail-detail-content {
        margin-top: 24px;
      }

      .mail-detail-content h4 {
        margin: 0 0 12px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-strong);
      }

      .mail-content-wrapper {
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 24px;
        background: var(--mail-content-bg);
        max-height: 600px;
        overflow-y: auto;
      }

      .mail-content-wrapper pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: ui-monospace, "SF Mono", Menlo, monospace;
        font-size: 0.875rem;
        line-height: 1.7;
        color: var(--text-subtle);
      }

      .mail-content-wrapper.html-content {
        padding: 0;
        background: var(--mail-frame-bg);
        overflow: visible;
        max-height: none;
      }

      .mail-content-wrapper iframe {
        width: 100%;
        border: none;
        display: block;
        background: var(--mail-frame-bg);
      }

      .mail-content-empty {
        color: var(--empty-text);
        font-style: italic;
        text-align: center;
        padding: 40px 0;
      }

      /* Form Table */
      .form-table {
        width: 100%;
        border-collapse: collapse;
      }

      .form-table td {
        padding: 12px 0;
      }

      .form-table td:first-child {
        width: 80px;
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--text-muted);
        padding-right: 16px;
      }

      /* Header Controls */
      .header-controls {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-top: 16px;
      }

      .header-controls select {
        flex: 1;
        max-width: 200px;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 40px 0;
        color: var(--loading-text);
        font-size: 0.875rem;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--empty-text);
      }

      .empty-state p {
        margin: 0;
        font-size: 0.9375rem;
      }

      /* Responsive */
      @media (max-width: 600px) {
        body {
          padding: 0;
        }

        .container {
          border-left: none;
          border-right: none;
          border-radius: 0;
        }

        .section-header {
          padding: 16px;
        }

        .section-header h3 {
          font-size: 1.25rem;
        }

        .section-content {
          padding: 16px;
        }

        .mail-list-table {
          font-size: 0.8125rem;
        }

        .mail-list-table th,
        .mail-list-table td {
          padding: 12px 8px;
        }

        .mail-list-table .subject-cell {
          padding-right: 8px;
        }

        .mail-list-table .action-cell {
          width: 70px;
        }

        .mail-detail-meta-row {
          grid-template-columns: 70px 1fr;
          padding: 12px 0;
        }

        .mail-detail-subject {
          font-size: 1.25rem;
          margin-bottom: 20px;
        }

        .mail-detail-content h4 {
          font-size: 0.9375rem;
        }

        .mail-content-wrapper {
          padding: 16px;
          border-radius: 4px;
        }

        .mail-content-wrapper.html-content {
          padding: 0;
        }

        .header-controls {
          flex-wrap: wrap;
        }

        button {
          font-size: 0.8125rem;
          padding: 6px 12px;
        }

        .scroll-top-btn {
          right: 16px;
          bottom: 64px;
        }
      }

      @media (max-width: 400px) {
        .mail-list-table .action-cell {
          width: 60px;
        }

        .mail-detail-meta-row {
          grid-template-columns: 60px 1fr;
          font-size: 0.8125rem;
        }
      }
    </style>
  </head>

  <body>
    <div id="app">
      <!-- Mail List View -->
      <div v-if="func === 'mails'" class="container">
        <div class="section-header">
          <h3>邮件列表</h3>
        </div>
        <div class="section-content">
          <p v-if="tipMessage" :class="['tip-message', { error: tipMessage.startsWith('ERROR') }]">{{ tipMessage }}</p>
          <div v-if="loading" class="loading">加载中...</div>
          <div v-else>
            <div v-if="mailList.length === 0" class="empty-state">
              <p>暂无邮件</p>
            </div>
            <table v-else class="mail-list-table">
              <thead>
                <tr>
                  <th>标题</th>
                  <th class="action-cell">操作</th>
                </tr>
              </thead>
              <tbody>
                <tr :key="mail.id" v-for="mail in mailList">
                  <td class="subject-cell">{{ mail.subject || '(无标题)' }}</td>
                  <td class="action-cell">
                    <button @click="viewMail(mail.id)" class="primary">查看</button>
                  </td>
                </tr>
              </tbody>
            </table>
            <button v-if="hasMore" @click="loadMoreMails" class="primary full-width">加载更多</button>
          </div>
        </div>
      </div>

      <!-- Mail Detail View -->
      <div v-if="func === 'mail-detail' && currentMail" class="container">
        <div class="section-header">
          <h3>邮件详情</h3>
          <div class="header-controls">
            <button @click="backToList">← 返回列表</button>
          </div>
        </div>
        <div class="section-content">
          <div class="mail-detail-meta">
            <div class="mail-detail-meta-row">
              <span class="mail-detail-label">发件人:</span>
              <span class="mail-detail-value">{{ currentMail.from }}</span>
            </div>
            <div class="mail-detail-meta-row">
              <span class="mail-detail-label">收件人:</span>
              <span class="mail-detail-value">{{ currentMail.to }}</span>
            </div>
            <div v-if="currentMail.receivedAt" class="mail-detail-meta-row">
              <span class="mail-detail-label">收件时间:</span>
              <span class="mail-detail-value">{{ formatFullDateTime(currentMail.receivedAt) }}</span>
            </div>
          </div>
          <h2 class="mail-detail-subject">{{ currentMail.subject || '(无标题)' }}</h2>
          <div class="mail-detail-content">
            <h4>邮件正文</h4>
            <div v-if="currentMail.html" :class="['mail-content-wrapper', 'html-content']">
              <iframe id="mail-content-frame" title="邮件正文预览" :srcdoc="currentMail.html" @load="syncFrameHeight"></iframe>
            </div>
            <div v-else-if="currentMail.text" class="mail-content-wrapper">
              <pre>{{ currentMail.text }}</pre>
            </div>
            <div v-else class="mail-content-empty">(正文为空)</div>
          </div>
        </div>
      </div>

      <!-- Address List Management -->
      <div v-if="func === 'list'" class="container">
        <div class="section-header">
          <h3>地址列表管理</h3>
          <div class="header-controls">
            <select v-model="mode" aria-label="选择列表类型">
              <option value="block">黑名单</option>
              <option value="white">白名单</option>
              <option value="test">测试地址</option>
            </select>
          </div>
        </div>
        <div class="section-content">
          <p v-if="tipMessage" :class="['tip-message', { error: tipMessage.startsWith('ERROR') }]">{{ tipMessage }}</p>

          <!-- Non-test mode: Add/Remove addresses -->
          <div v-if="mode !== 'test'">
            <div class="address-input-row">
              <input type="text" :placeholder="inputPlaceholder" v-model="inputAddress" @keyup.enter="addAddress" aria-label="地址输入" />
              <button @click="addAddress" class="primary">添加</button>
            </div>
            <ul class="address-list" v-if="addresses.length > 0">
              <li :key="index" v-for="(address, index) in addresses" class="address-item">
                <span class="address-text">{{ address }}</span>
                <button @click="removeAddress(index)" class="danger">删除</button>
              </li>
            </ul>
            <div v-else class="empty-state">
              <p>暂无地址</p>
            </div>
          </div>

          <!-- Test mode: Test addresses -->
          <div v-else>
            <div class="address-input-row">
              <input type="text" :placeholder="inputPlaceholder" v-model="inputAddress" @keyup.enter="testAddress" aria-label="测试地址输入" />
              <button @click="testAddress" class="primary">测试</button>
            </div>
            <ul class="address-list" v-if="addresses.length > 0">
              <li :key="index" v-for="(item, index) in addresses" class="address-item">
                <span class="address-text">{{ item.address }}</span>
                <span :class="['address-badge', item.result]">{{ item.result }}</span>
              </li>
            </ul>
            <div v-else class="empty-state">
              <p>输入地址后点击测试</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Send Mail (Future Feature) -->
      <div v-if="func === 'sendmail'" class="container">
        <div class="section-header">
          <h3>发送邮件</h3>
        </div>
        <div class="section-content">
          <p v-if="tipMessage" :class="['tip-message', { error: tipMessage.startsWith('ERROR') }]">{{ tipMessage }}</p>
          <table class="form-table">
            <tbody>
              <tr>
                <td>发件人</td>
                <td>
                  <input type="email" v-model="sendMail.from" placeholder="sender@example.com" aria-label="发件人" />
                </td>
              </tr>
              <tr>
                <td>收件人</td>
                <td>
                  <input type="email" v-model="sendMail.to" placeholder="recipient@example.com" aria-label="收件人" />
                </td>
              </tr>
              <tr>
                <td>标题</td>
                <td>
                  <input type="text" v-model="sendMail.subject" placeholder="邮件标题" aria-label="邮件标题" />
                </td>
              </tr>
              <tr>
                <td>正文</td>
                <td>
                  <textarea v-model="sendMail.text" placeholder="邮件正文" aria-label="邮件正文"></textarea>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <button class="primary full-width">发送</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <button v-if="showScrollTop" class="scroll-top-btn primary" @click="scrollToTop" aria-label="返回顶部">↑ 返回顶部</button>
    </div>

    <script>
      const setTheme = (scheme) => {
        const theme = scheme === "dark" ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", theme);
      };

      const initTheme = () => {
        const tg = window.Telegram && window.Telegram.WebApp;

        if (tg && typeof tg.colorScheme === "string") {
          setTheme(tg.colorScheme);
          if (typeof tg.onEvent === "function") {
            tg.onEvent("themeChanged", () => setTheme(tg.colorScheme));
          }
        } else {
          const media = window.matchMedia("(prefers-color-scheme: dark)");
          const apply = (value) => setTheme(value ? "dark" : "light");
          apply(media.matches);
          const handler = (event) => apply(event.matches);
          if (typeof media.addEventListener === "function") {
            media.addEventListener("change", handler);
          } else if (typeof media.addListener === "function") {
            media.addListener(handler);
          }
        }
      };

      initTheme();

      const formatError = (error) => (error instanceof Error ? error.message : String(error ?? ""));

  const { createApp, computed, ref, onMounted, onUnmounted, watch } = Vue;

      class Client {
        constructor(tma) {
          this.tma = tma;
        }

        async request(path, method, body) {
          const options = {
            method,
            headers: {
              "Content-Type": "application/json",
              Authorization: `tma ${this.tma}`,
            },
          };

          if (body !== undefined) {
            options.body = JSON.stringify(body);
          }

          const res = await fetch(path, options).then((response) => response.json());
          if (res.error) {
            throw new Error(res.error);
          }
          return res;
        }

        async addAddress(address, type) {
          return this.request("/api/address/add", "POST", {
            address,
            type,
          });
        }

        async removeAddress(address, type) {
          return this.request("/api/address/remove", "POST", {
            address,
            type,
          });
        }

        async loadAddress() {
          return this.request("/api/address/list", "GET");
        }

        async loadMails(limit, cursor) {
          const params = new URLSearchParams();
          if (limit) params.append("limit", limit);
          if (cursor) params.append("cursor", cursor);
          const query = params.toString();
          return this.request(`/api/mails/list${query ? "?" + query : ""}`, "GET");
        }

        async loadMailDetail(id) {
          return this.request(`/api/mails/${id}`, "GET");
        }
      }

      createApp({
        setup() {
          const urlParams = new URLSearchParams(window.location.search);

          const blockList = ref([]);
          const whiteList = ref([]);
          const testList = ref([]);
          const listRegistry = {
            block: blockList,
            white: whiteList,
            test: testList,
          };
          const tipMessage = ref("");
          const inputAddress = ref("");
          const loading = ref(false);
          const mailList = ref([]);
          const currentMail = ref(null);
          const cursor = ref(null);
          const hasMore = ref(false);
          const showScrollTop = ref(false);

          const sendMail = ref({
            from: "",
            to: "",
            subject: "",
            text: "",
          });

          const func = ref(urlParams.get("func") || "list");
          const mode = ref(urlParams.get("mode") || "block");
          const client = new Client("");

          const addresses = computed(() => listRegistry[mode.value]?.value ?? []);

          const placeholders = {
            block: "New block address regex",
            white: "New white address regex",
            test: "Test address",
          };

          const inputPlaceholder = computed(() => placeholders[mode.value] ?? placeholders.block);

          const toggleScrollTop = () => {
            showScrollTop.value = window.scrollY > 300 && func.value === "mail-detail";
          };

          const scrollToTop = () => {
            window.scrollTo({ top: 0, behavior: "smooth" });
          };

          const addAddress = async () => {
            const address = inputAddress.value.trim();
            if (!address) return;

            try {
              await client.addAddress(address, mode.value);
              inputAddress.value = "";
              if (mode.value !== "test") {
                listRegistry[mode.value]?.value.push(address);
              }
              tipMessage.value = "";
            } catch (error) {
              tipMessage.value = `ERROR: ${formatError(error)}`;
            }
          };

          const removeAddress = async (index) => {
            try {
              const address = addresses.value[index];
              if (!address) return;
              await client.removeAddress(address, mode.value);
              if (mode.value !== "test") {
                listRegistry[mode.value]?.value.splice(index, 1);
              }
              tipMessage.value = "";
            } catch (error) {
              tipMessage.value = `ERROR: ${formatError(error)}`;
            }
          };

          const testAddressWithPattern = (pattern, address) => {
            if (pattern.toLowerCase() === address.toLowerCase()) {
              return true;
            }
            try {
              const regex = new RegExp(pattern, "i");
              return !!regex.test(address);
            } catch (e) {
              return false;
            }
          };

          const testAddress = () => {
            const address = inputAddress.value.trim();
            if (!address) {
              testList.value = [];
              return;
            }

            const results = [];
            const targets = [
              { patterns: blockList.value, result: "block" },
              { patterns: whiteList.value, result: "white" },
            ];

            for (const { patterns, result } of targets) {
              for (const pattern of patterns) {
                if (testAddressWithPattern(pattern, address)) {
                  results.push({ address: pattern, result });
                }
              }
            }

            testList.value = results;
          };

          const loadMails = async () => {
            try {
              loading.value = true;
              const result = await client.loadMails(50, cursor.value);
              mailList.value = [...mailList.value, ...result.mails];
              cursor.value = result.cursor;
              hasMore.value = !!result.cursor;
              tipMessage.value = "";
            } catch (error) {
              tipMessage.value = `ERROR: ${formatError(error)}`;
            } finally {
              loading.value = false;
            }
          };

          const loadMoreMails = async () => {
            await loadMails();
          };

          const viewMail = async (id) => {
            try {
              loading.value = true;
              const mail = await client.loadMailDetail(id);
              currentMail.value = mail;
              func.value = "mail-detail";
              tipMessage.value = "";
            } catch (error) {
              tipMessage.value = `ERROR: ${formatError(error)}`;
            } finally {
              loading.value = false;
            }
          };

          const backToList = () => {
            func.value = "mails";
            currentMail.value = null;
          };

          const formatFullDateTime = (timestamp) => {
            if (!timestamp) return "-";
            try {
              const date = new Date(timestamp);
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, "0");
              const day = String(date.getDate()).padStart(2, "0");
              const hours = String(date.getHours()).padStart(2, "0");
              const minutes = String(date.getMinutes()).padStart(2, "0");
              const seconds = String(date.getSeconds()).padStart(2, "0");

              return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (e) {
              return "-";
            }
          };

          let resizeObserver = null;

          const syncFrameHeight = () => {
            const frame = document.getElementById("mail-content-frame");
            if (!frame) return;

            const updateHeight = () => {
              try {
                const doc = frame.contentDocument || (frame.contentWindow && frame.contentWindow.document);
                if (!doc) {
                  // Fallback height if can't access document
                  frame.style.height = "500px";
                  return;
                }

                // Wait for content to be fully rendered
                setTimeout(() => {
                  const body = doc.body;
                  const html = doc.documentElement;

                  if (!body || !html) {
                    frame.style.height = "500px";
                    return;
                  }

                  // Calculate the maximum height needed
                  let height = Math.max(body.scrollHeight || 0, body.offsetHeight || 0, html.scrollHeight || 0, html.offsetHeight || 0, body.getBoundingClientRect().height || 0);

                  // Add some padding to prevent cutoff
                  height = Math.max(height + 20, 200);

                  frame.style.height = height + "px";

                  // Set up ResizeObserver for dynamic content changes
                  if ("ResizeObserver" in window && !resizeObserver) {
                    resizeObserver = new ResizeObserver(() => {
                      const newHeight = Math.max(body.scrollHeight || 0, body.offsetHeight || 0, html.scrollHeight || 0, html.offsetHeight || 0, body.getBoundingClientRect().height || 0) + 20;

                      if (newHeight > 200) {
                        frame.style.height = newHeight + "px";
                      }
                    });
                    resizeObserver.observe(body);
                    if (html !== body) {
                      resizeObserver.observe(html);
                    }
                  }

                  // Also check for images loading
                  const images = doc.querySelectorAll("img");
                  if (images.length > 0) {
                    let loadedCount = 0;
                    images.forEach((img) => {
                      if (img.complete) {
                        loadedCount++;
                      } else {
                        img.addEventListener("load", () => {
                          loadedCount++;
                          if (loadedCount === images.length) {
                            updateHeight();
                          }
                        });
                      }
                    });
                  }
                }, 100);
              } catch (err) {
                // Cross-origin restriction or other errors
                console.warn("Frame height sync error:", err);
                frame.style.height = "500px";
              }
            };

            updateHeight();

            // Also retry after a delay to catch late-rendering content
            setTimeout(updateHeight, 300);
            setTimeout(updateHeight, 800);
          };

          watch(mode, () => {
            inputAddress.value = "";
          });

          watch(func, () => {
            if (func.value !== "mail-detail") {
              showScrollTop.value = false;
            }
            toggleScrollTop();
          });

          watch(currentMail, (newVal, oldVal) => {
            // Clean up observer when switching mails
            if (oldVal && newVal !== oldVal && resizeObserver) {
              resizeObserver.disconnect();
              resizeObserver = null;
            }
          });

          onMounted(async () => {
            toggleScrollTop();
            window.addEventListener("scroll", toggleScrollTop, { passive: true });
            try {
              const tg = window.Telegram && window.Telegram.WebApp;
              client.tma = tg?.initData ?? "";
              tg?.ready?.();

              if (func.value === "mails") {
                await loadMails();
              } else if (func.value === "list") {
                const { block = [], white = [] } = await client.loadAddress();
                blockList.value = block;
                whiteList.value = white;
              }
            } catch (error) {
              tipMessage.value = `ERROR: ${formatError(error)}`;
            }
          });

          onUnmounted(() => {
            window.removeEventListener("scroll", toggleScrollTop);
            if (resizeObserver) {
              resizeObserver.disconnect();
              resizeObserver = null;
            }
          });

          return {
            addresses,
            tipMessage,
            inputAddress,
            inputPlaceholder,
            sendMail,
            mode,
            func,
            addAddress,
            removeAddress,
            testAddress,
            loading,
            mailList,
            currentMail,
            hasMore,
            loadMoreMails,
            viewMail,
            backToList,
            formatFullDateTime,
            syncFrameHeight,
            scrollToTop,
            showScrollTop,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
